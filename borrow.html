<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>相机借用申请</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: system-ui, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 24px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 24px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        th {
            background: #f0f0f0;
        }

        label {
            display: block;
            margin-top: 12px;
            font-size: 14px;
        }

        input,
        select {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            box-sizing: border-box;
        }

        .row {
            display: flex;
            gap: 16px;
        }

        .row>div {
            flex: 1;
        }

        button {
            margin-top: 20px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
        }

        .msg {
            margin-top: 16px;
            font-size: 15px;
        }

        .msg.error {
            color: #c00;
        }

        .msg.success {
            color: #0a7;
        }

        .code-box {
            margin-top: 10px;
            padding: 10px;
            background: #f3f3f3;
            border-radius: 6px;
            font-family: monospace;
        }
    </style>
</head>

<body>

    <h1>相机借用申请</h1>

    <h2>当前设备状态</h2>
    <table>
        <thead>
            <tr>
                <th>设备名称</th>
                <th>型号</th>
                <th>状态</th>
                <th>借用单位</th>
                <th>联系人</th>
                <th>微信</th>
                <th>借用时间</th>
            </tr>
        </thead>
        <tbody id="device-status-body">
            <tr>
                <td colspan="7">加载中...</td>
            </tr>
        </tbody>
    </table>

    <h2>填写借用信息</h2>
    <form id="borrow-form">
        <label>借用单位
            <input type="text" id="org_name" required />
        </label>

        <label>联系人姓名
            <input type="text" id="contact_name" required />
        </label>

        <label>联系人微信号
            <input type="text" id="contact_phone" required />
        </label>

        <label>选择设备
            <select id="device_id" required></select>
        </label>

        <div class="row">
            <div>
                <label>借用日期时间
                    <input type="datetime-local" id="take_time" required />
                </label>
            </div>
            <div>
                <label>归还日期时间
                    <input type="datetime-local" id="return_time" required />
                </label>
            </div>
        </div>

        <div class="row">
            <div>
                <label>活动开始时间
                    <input type="datetime-local" id="event_start_time" required />
                </label>
            </div>
            <div>
                <label>活动结束时间
                    <input type="datetime-local" id="event_end_time" required />
                </label>
            </div>
        </div>

        <div class="row">
            <div>
                <label>充电器数量
                    <input type="number" min="0" value="0" id="charger_count" />
                </label>
            </div>
            <div>
                <label>电池数量
                    <input type="number" min="0" value="0" id="battery_count" />
                </label>
            </div>
            <div>
                <label>相机包数量
                    <input type="number" min="0" value="0" id="bag_count" />
                </label>
            </div>
        </div>

        <button type="submit">提交借用申请</button>
    </form>

    <div id="result" class="msg"></div>
    <div id="ticket" class="code-box" style="display:none;"></div>

    <script>
        // const SUPABASE_URL = "https://oivoqbmnvfawbeaplphz.supabase.co";
        // const SUPABASE_ANON_KEY = "你的 anon key";
        // const BORROW_FUNCTION_URL = "https://oivoqbmnvfawbeaplphz.supabase.co/functions/v1/borrow";
        const SUPABASE_URL = "https://oivoqbmnvfawbeaplphz.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9pdm9xYm1udmZhd2JlYXBscGh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTk3NzEsImV4cCI6MjA4MDYzNTc3MX0.GOX1M7SASmLnd6dYjxpTRGAZ-pYdwwmm9Qg576XIL_c";
        const BORROW_FUNCTION_URL = "https://oivoqbmnvfawbeaplphz.supabase.co/functions/v1/borrow";


        const { createClient } = window.supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const deviceStatusBody = document.getElementById("device-status-body");
        const deviceSelect = document.getElementById("device_id");

        async function loadDeviceStatus() {
            const { data: devices, error: dErr } = await supabaseClient
                .from("devices")
                .select("*")
                .order("id");

            if (dErr || !devices) {
                deviceStatusBody.innerHTML = `<tr><td colspan="7">加载失败</td></tr>`;
                return;
            }

            const { data: records } = await supabaseClient
                .from("borrow_records")
                .select("*")
                .is("actual_return_time", null);

            deviceStatusBody.innerHTML = "";
            deviceSelect.innerHTML = `<option value="">请选择设备</option>`;

            devices.forEach(d => {
                const devRecords = (records || []).filter(r => r.device_id === d.id);
                deviceSelect.innerHTML += `<option value="${d.id}">${d.name}</option>`;

                if (devRecords.length === 0) {
                    deviceStatusBody.innerHTML += `
                        <tr>
                            <td>${d.name}</td>
                            <td>${d.code}</td>
                            <td>空闲</td>
                            <td></td><td></td><td></td><td></td>
                        </tr>`;
                } else {
                    devRecords.forEach(rec => {
                        const s = new Date(rec.take_time);
                        const e = new Date(rec.return_time);
                        deviceStatusBody.innerHTML += `
                            <tr>
                                <td>${d.name}</td>
                                <td>${d.code}</td>
                                <td>使用中</td>
                                <td>${rec.org_name || ""}</td>
                                <td>${rec.contact_name || ""}</td>
                                <td>${rec.contact_phone || ""}</td>
                                <td>${s.toLocaleString()} ~ ${e.toLocaleString()}</td>
                            </tr>`;
                    });
                }
            });
        }

        loadDeviceStatus();
    </script>

</body>

</html>
